<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd
file:///opt/casa/code/xmlcasa/xml/casa.xsd">

<task type="function" name="polcal" category="calibration">
<shortdescription>Determine instrumental polarization calibrations</shortdescription>

<description>
The complex instrumental polarization factors (D-terms) for each antenna/spwid 
are determined from the data for the specified calibrator sources. Previous 
calibrations can be applied on the fly.
</description>
<input>
	<param type="string" name="vis" mustexist="true">
		<description>Name of input visibility file</description>
		<value></value>
	</param>

	<param type="string" name="caltable">
		<description>Name of output gain calibration table</description>
		<value></value>
	</param>

	<param type="string" name="field">
		<description>Select field using field id(s) or field name(s)</description>
		<value></value>
	</param>

	<param type="string" name="spw">
		<description>Select spectral window/channels</description>
		<value></value>
	</param>

	<param type="bool" name="selectdata">
		<description>Other data selection parameters</description>
		<value>True</value>
	</param>

	<param type="string" name="timerange" subparam="true">
		<description>Select data based on time range</description>
		<value></value>
	</param>

	<param type="any" name="uvrange" subparam="true">
		<description>Select data within uvrange (default units meters)</description>
		<any type="variant"/>
		<value type="string"></value>
	</param>

	<param type="string" name="antenna" subparam="true">
		<description>Select data based on antenna/baseline</description>
		<value></value>
	</param>

	<param type="string" name="scan" subparam="true">
		<description>Scan number range</description>
		<value></value>
	</param>

	<param type="string" name="msselect" subparam="true">
		<description>Optional complex data selection (ignore for now)</description>
		<value></value>
	</param>

        <param type="any" name="solint">
                <description>Solution interval</description>
                <any type="variant"/>
                <value type="string">inf</value>
        </param>

        <param type="string" name="combine">
                <description>Data axes which to combine for solve (scan, spw, and/or field)</description>
                <value>scan</value>
        </param>

	<param type="double" name="preavg">
		<description>Pre-averaging interval (sec)</description>
		<value>300.0</value>
	</param>

	<param type="string" name="refant">
		<description>Reference antenna name</description>
		<value></value>
	</param>

	<param type="int" name="minblperant">
		<description>Minimum baselines _per antenna_ required for solve</description>
		<value>4</value>
	</param>

	<param type="double" name="minsnr">
		<description>Reject solutions below this SNR</description>
		<value>0.0</value>
	</param>

	<param type="string" name="poltype">
		<description>Type of instrumental polarization solution (see help)</description>
		<value>D+QU</value>
		<allowed kind="enum">
			<value>D</value>
			<value>Df</value>
			<value>D+X</value>
			<value>Df+X</value>
			<value>D+QU</value>
			<value>Df+QU</value>
                        <value>Dgen</value>
                        <value>Dfgen</value>
                        <value>Dgen+X</value>
                        <value>Dfgen+X</value>
                        <value>Dgen+QU</value>
                        <value>Dfgen+QU</value>
			<value>X</value>
			<value>Xf</value>
			<value>Xj</value>
		</allowed>
	</param>

        <param type="doubleArray" name="smodel">
               <description>Point source Stokes parameters for source model.</description>
               <value></value>
        </param>

	<param type="bool" name="append">
		<description>Append solutions to the (existing) table</description>
		<value>False</value>
	</param>

	<param type="stringArray" name="gaintable">
		<description>Gain calibration table(s) to apply</description>
		<value></value>
	</param>

	<param type="stringArray" name="gainfield">
		<description>Select a subset of calibrators from gaintable(s)</description>
		<value></value>
	</param>

	<param type="stringArray" name="interp">
		<description>Interpolation mode (in time) to use for each gaintable</description>
		<value></value>
		<allowed kind="enum">
			<value>nearest</value>
			<value>linear</value>
			<value>aipslin</value>
			<value></value>
		</allowed>
	</param>

	<param type="intArray" name="spwmap">
		<description>Spectral windows combinations to form for gaintables(s)</description>
		<value></value>
	</param>

	<param type="bool" name="gaincurve">
		<description>Apply internal VLA antenna gain curve correction</description>
		<value>False</value>
	</param>

	<param type="double" name="opacity">
		<description>Opacity correction to apply (nepers)</description>
		<value>0.0</value>
	</param>
   <constraints>
	<when param="selectdata">
		<equals type="bool" value="True">
			<default param="timerange"><value type="string"/></default>
			<default param="uvrange"><value type="string"/></default>
			<default param="antenna"><value type="string"/></default>
			<default param="scan"><value type="string"/></default>
			<default param="msselect"><value type="string"/></default>
		</equals>
		<equals type="bool" value="False"/>
	</when>
   </constraints>
</input>
<example>

      The instrumental polarization factors (D-terms), the calibrator polarization,
      and the R-L polarization angle can be determined using polcal.  The solutions
      can be obtained for each antenna/spwid and even individual channels, if desired.
      Previous calibrations of the total intensity data should be applied on the fly
      when running polcal, since polcal uses the 'data' column, not the 'corrected'
      column.

      After calibrating the total intensities, the simplest way to calibrate the 
      polarization data is:

        a) Run polcal with poltype = 'D+QU' on the main 'calibrator' source.  The D terms
           and polarization (QU) of the calibrator will be determined.  Relatively good
           parallactic angle coverage is needed.

        b) If there is little parallactic angle coverage, place the known calibration of
           the main calibrator (or 0) using setjy with the appropriate fluxdensity.  Then
           run polcal with poltype = 'D'.  Run plotcal with xaxis = 'real'; yaxis ='imag'
           to view solutions.

        c) To determine R-L polarization angle, use setjy to put the fluxdensity of the
           polarization calibrator [I,Q,U,0.0] in the model column.  For resolved sources
           put in values associated with an appropriate u-v range.  Polarized models are
           not yet available for the major polarization standard sources, so very
           resolved polarized sources should not be used.

        d) Run polcal with poltype = 'X' and include polarization standard.  Make sure to
           include all previous calibrations, especially the D results.  Run plotxy with
           correlation = 'RL LR' and make sure polarization angles are as expected.

        e) Run applycal with all calibration table, include the D and X tables.  Make sure
           that parang = T

         NOTE: For very high dynamic range, add 'f' after D to determine D terms for each
               channel.

      Keyword arguments:
      vis -- Name of input visibility file
              default: none; example: vis='ngc5921.ms'
      caltable -- Name of output gain calibration table
              default: none; example: caltable='ngc5921.dcal'

      --- Data Selection (see help par.selectdata for more detailed information)

      field -- Select field using field id(s) or field name(s).
                 [run listobs to obtain the list id's or names]
              default: ''=all fields.
                  Most likely, the main calibrator source should be picked.
              If field string is a non-negative integer, it is assumed a field index
                otherwise, it is assumed a field name
              field='0~2'; field ids 0,1,2
              field='0,4,5~7'; field ids 0,4,5,6,7
              field='3C286,3C295'; field named 3C286 adn 3C295
              field = '3,4C*'; field id 3, all names starting with 4C
      spw -- Select spectral window/channels 
               type 'help par.selection' for more examples.
             spw='0~2,4'; spectral windows 0,1,2,4 (all channels)
             spw='&lt;2';  spectral windows less than 2 (i.e. 0,1)
             spw='0:5~61'; spw 0, channels 5 to 61, INCLUSIVE
             spw='*:5~61'; all spw with channels 5 to 62
             spw='0,10,3:3~45'; spw 0,10 all channels, spw 3, channels 3 to 45.
             spw='0~2:2~6'; spw 0,1,2 with channels 2 through 6 in each.
             spw='0:0~10;15~60'; spectral window 0 with channels 0-10,15-60
                       NOTE ';' to separate channel selections
             spw='0:0~10^2,1:20~30^5'; spw 0, channels 0,2,4,6,8,10,
                   spw 1, channels 20,25,30
      selectdata -- Other data selection parameters
              default: True
      timerange  -- Select data based on time range:
              default = '' (all); examples,
              timerange = 'YYYY/MM/DD/hh:mm:ss~YYYY/MM/DD/hh:mm:ss'
              Note: if YYYY/MM/DD is missing dat defaults to first day in data set
              timerange='09:14:0~09:54:0' picks 40 min on first day
              timerange= '25:00:00~27:30:00' picks 1 hr to 3 hr 30min on next day
              timerange='09:44:00' data within one integration of time
              timerange='&gt;10:24:00' data after this time
      uvrange -- Select data within uvrange (default units meters)
              default: '' (all); example:
              uvrange='0~1000'; uvrange from 0-1000 kilo-lamgda
              uvrange='&gt;4';uvranges greater than 4 kilo-lambda
      antenna -- Select data based on antenna/baseline
              default: '' (all)
              If antenna string is a non-negative integer, it is assumed an antenna index
                otherwise, it is assumed as an antenna name
              antenna='5&amp;6'; baseline between antenna index 5 and index 6.
              antenna='VA05&amp;VA06'; baseline between VLA antenna 5 and 6.
              antenna='5&amp;6;7&amp;8'; baseline 5-6 and 7-8
              antenna='5'; all baselines with antenna index 5
              antenna='05'; all baselines with antenna name 05, i.e. VLA ant 5
              antenna='5,6,10'; all baselines with antennas 5, 6 and 10
      scan -- Scan number range
      msselect -- Optional complex data selection (ignore for now)

      --- Solution parameters
      poltype -- Type of instrumental polarization solution
              'D+QU' (or 'Df+QU')  solve also for apparent source polarization (channelized D)
                 Need relatively good parallactic angle coverage for this
              'D' (or 'Df') solve only for instrumental polarization (channelized).  The
                 I, Q, U flux density of the source can be placed in the model column using
                 setjy.  Use for poor parallactic angle coverage.
              'X' = solve only for position angle correction.  The source must have its
                 I, Q, U flux density in the model column.  If the source is resolved, use
                 a uvrange that is appropriate.
              'D+X' (or 'Df+X') = solve also for position angle offset (channelized D) as
                 well as the D-term.  Not normally done.
              default: 'D+QU'
              The solution used the traditional linear approximation.  Non-linearized options
                  will be avaible soon.
      solint --  Solution interval (units optional) 
              default: 'inf' (~infinite, up to boundaries controlled by combine); 
              Options: 'inf' (~infinite), 'int' (per integration), any float
                       or integer value with or without units
              examples: solint='1m'; solint='60s', solint=60 --&gt; 1 minute
                        solint='0s'; solint=0; solint='int' --&gt; per integration
                        solint-'-1s'; solint='inf' --&gt; ~infinite, up to boundaries
                        enforced by combine
      combine -- Data axes to combine for solving
              default: 'scan' --&gt; solutions will break at field and spw boundaries,
                        but may extend over multiple scans (per field and spw) up
                        to solint.
              Options: '','scan','spw',field', or any comma-separated combination
              example: combine='scan,spw'  --&gt; extend solutions over scan boundaries
                       (up to the solint), and combine spws for solving
      preavg -- Pre-averaging interval (sec)
              default=300
              Interval to apply parallactic angle.
      refant -- Reference antenna name
              default: '' =&gt; refant = '0'
              example: refant='13' (antenna with index 13)
                       refant='VA04' (VLA antenna #4)
              Use 'go listobs' for antenna listing.
              USE SAME REFERENCE ANTENNA AS USED FOR I CALIBRATION.
      minblperant -- Minimum number of baselines required per antenna for each solve
                   Antennas with fewer baaselines are excluded from solutions. Amplitude
                   solutions with fewer than 4 baselines, and phase solutions with fewer 
                   than 3 baselines are only trivially constrained, and are no better
                   than baseline-based solutions.
                   default: 4
                   example: minblperant=10  =&gt; Antennas participating on 10 or more 
                            baselines are included in the solve
      minsnr -- Reject solutions below this SNR
              default: 0.0 (accept all attempted solutions)
      append -- Append solutions to the (existing) table
              default: False; overwrite existing table or make new table

      --- Other calibrations to apply on the fly before determining gaincal solution

      gaintable -- Gain calibration table(s) to apply 
               default: '' (none);  BUT I CALIBRATION TABLES SHOULD GENERALLY BE INCLUDED
               examples: gaintable='ngc5921.gcal'
                         gaintable=['ngc5921.ampcal','ngc5921.phcal']
      gainfield -- Select a subset of calibrators from gaintable(s)
               default:'' ==&gt; all sources in table;
               same syntax as field
               example: gainfield='0~3'
                        gainfield=['0~3','4~6'] means use field 0 through 3
                          from first gain file, field 4 through 6 for second.
      interp -- Interpolation mode (in time) to use for each gaintable
                default: '' --&gt; 'linear' for all gaintable(s)
                example: interp='nearest'
                         interp=['nearest','linear']
                Options: 'nearest', 'linear', 'aipslin'
      spwmap -- Spectral windows combinations to form for gaintable(s)
                default: [] (apply solutions from each spw to that spw only)
                Example:  spwmap=[0,0,1,1] means apply the caltable solutions
                          from spw = 0 to the spw 0,1 and spw 1 to spw 2,3.
                          spwmap=[[0,0,1,1],[0,1,0,1]]
      gaincurve -- Apply internal VLA antenna gain curve correction (True/False)
               default: False;
               Use gaincurve=True ONLY for VLA data
      opacity -- Opacity correction to apply (nepers)
               default: 0.0 (no opacity correction)
               example: opacity=0.051
               Typical VLA values are: 5 GHz - 0.013, 8 GHz - 0.013
               15 GHz - 0.016, 23 GHz - 0.051, 43 GHz - 0.07
      async --  Run asynchronously
               default = False; do not run asychronously
</example> 

</task>
</casaxml>
