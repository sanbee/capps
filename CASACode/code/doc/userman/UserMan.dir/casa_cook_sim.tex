% STM 2007-04-13  split from previous version
% STM 2007-10-11  add into beta
% STM 2007-10-22  put in appendix for Beta Release
% RI  2009-12-17  Release 0 (3.0.0) draft
% STM 2009-12-21  Release 0 (3.0.0) final
% RI 2010-04-10 Release 3.0.1

%\chapter{Simulation}
\chapter[Appendix: Simulation]{Simulation}
\label{chapter:sim}

{\bfseries New in 3.1:} {\tt simdata} is the new, and preferred,
task to use.  The legacy interface is now called {\tt oldsimdata}.

The capability for simulating observations and datasets from the EVLA
and ALMA are an important use-case for CASA.  This not only allows one
to get an idea of the capabilities of these instruments for doing
science, but also provides benchmarks for the performance and utility
of the software for processing ``realistic'' datasets (with
atmospheric and instrumental effects).  CASA can now calculate
visibilities (create a measurement set) for any interferometric array,
and calculate and apply calibration tables representing some of the
most important corrupting effects.  One can use the {\tt sdsim} task
to simulate single dish or total power data.  (the ASAP package must
be loaded, see Sect.\,\ref{chapter:sd}).

\begin{wrapfigure}{r}{2.5in}
 \begin{boxedminipage}{2.5in}
    \centerline{\bf Inside the Toolkit:}
    The simulator methods are in the {\tt sm} tool.
    Many of the other tools are also helpful when
    constructing and analyzing simulations.
 \end{boxedminipage}
\end{wrapfigure}

CASA's simulation capabilities have been under development, and will
continue to evolve through this and the next release of CASA.
For the most current information, please refer to
\url{http://www.casaguides.nrao.edu}, and click on ``Simulating
Observations in CASA''.
%
Following general CASA practice, the greatest flexibility and richest
functionality is at the Toolkit level.  The most commonly used
procedures for interferometric simulation are encapsulated in the {\tt
simdata} task.  Total power simulation is possible at the task level
using the {\tt sdsim} task, and incorporated directly into {\tt
simdata} (one can create and jointly deconvolve synthetic single dish
and interferometric datasets).
%which follows somewhat parallel inputs
%and whose capabilities will being developed more fully in the next
%release.

%{\bf BETA ALERT:} The simulation capabilities are currently under
%development.  What we do have is mostly at the Toolkit level.
%We have only a single task {\tt almasimmos} at the present time.
%Stay tuned.  For the Beta Release, we include this chapter
%in the Appendix for the use of telescope commissioners and software
%developers.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Simulating ALMA with {\tt simdata}}
\label{section:sim.almasimmos}

The inputs are:
\small
\begin{verbatim}
#  simdata :: mosaic simulation task:
project             =      'sim'        #  root for output file names
modifymodel         =      False        #  modify model image
     skymodel       = '$project.skymodel' #  model image to observe or modify

setpointings        =       True        
     integration    =      '10s'        #  integration (sampling) time
     direction      = ['J2000 19h00m00 -40d00m00'] #  "J2000 19h00m00 -40d00m00" or "" to center on model
     mapsize        = ['1arcmin', '1arcmin'] #  angular size of map or "" to cover model
     maptype        = 'hexagonal'       #  hexagonal, square, etc
     pointingspacing =  '1arcmin'       #  spacing in between pointings or "" for 0.5 PB

predict             =       True        #  calculate visibilites using ptgfile
     complist       =         ''        #  optional componentlist to observe with skymodel
     antennalist    = 'alma.out10.cfg'  #  antenna position file or "" for no interferometric MS
     refdate        = '2012/05/21/22:05:00' #  time/date of observation *see help
     totaltime      =    '7200s'        #  total time of observation
     caldirection   =         ''        #  pt source calibrator [experimental]
     calflux        =      '1Jy'        
     sdantlist      =         ''        #  single dish antenna position file or "" for no total power MS
     sdant          =          0        #  single dish antenna index in file

thermalnoise        = 'tsys-atm'        #  add thermal noise: [tsys-atm|tsys-manual|""]
     user_pwv       =        1.0        #  Precipitable Water Vapor in mm
     t_ground       =      269.0        #  ambient temperature

leakage             =        0.0        #  cross polarization
image               =       True        #  (re)image $project.ms to $project.image
     vis            = '$project.ms'     #  Measurement Set(s) to image
     modelimage     =         ''        #  prior image to use in clean e.g. existing single dish image
     imsize         = [128, 128]        #  output image size in pixels (x,y) or 0 to match model
     cell           = '0.1arcsec'       #  cell size with units or "" to equal model
     niter          =        500        #  maximum number of iterations (0 for dirty image)
     threshold      =  '0.01mJy'        #  flux level (+units) to stop cleaning
     weighting      =  'natural'        #  weighting to apply to visibilities
     outertaper     =         []        #  uv-taper on outer baselines in uv-plane
     stokes         =        'I'        #  Stokes params to image

analyze             =       True        #  (only first 6 selected outputs will be displayed)
     showarray      =      False        #  like plotants
     showuv         =       True        #  display uv coverage
     showpsf        =       True        #  display synthesized (dirty) beam
     showmodel      =       True        #  display sky model at original resolution
     showconvolved  =      False        #  display sky model convolved with output beam
     showclean      =       True        #  display the synthesized image
     showresidual   =      False        #  display the clean residual image
     showdifference =       True        #  display difference image
     showfidelity   =       True        #  display fidelity

graphics            =   'screen'        #  display graphics at each stage to [screen|file|both|none]
verbose             =      False        
overwrite           =      False        #  overwrite files starting with $project
async               =      False        #  If true the taskname must be started using simdata(...)
\end{verbatim}
\normalsize

This task takes an input model image or list of components, plus a
list of antennas (locations and sizes), and simulates a particular
observation (specifies by mosaic setup and observing cycles and
times).  The output is a MS suitable for further analysis in CASA, a
synthesized image create from those visibilities, a difference image
between the synthesized image and your sky model convolved with the
output synthesized beam, and a fidelity image.

{\tt simdata} is modular: one can
modify one's sky model, predict visibilities, corrupt the Measurement
Set, re-image, and analyze the result all separately, provided in a
few cases the filenames are set correctly.  The description of the sky
model is not coupled directly to the size and cell size of the
output image as it was in {\tt oldsimdata}

Random thermal noise (from the atmosphere and receiver) can optionally
be added. A realistic model of the troposphere is created from known
site characteristics (altitude, etc) and used to calculate the
frequency dependence of the noise.  Similarly, specifications for ALMA
and EVLA receiver temperature and antenna efficiencies are coded into
the task to determine a realistic system temperature.  Other
corrupting effects, such as phase noise, gain drift, and
cross-polarization, can be added the the MS with the toolkit.

Much more detailed information, and use-case examples, can be found at 

\url{http://casaguides.nrao.edu/index.php?title=Simulating_Observations_in_CASA}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Simulating ALMA with {\tt oldsimdata}}
\label{section:sim.almasimmos_old}

{\bfseries Warning:} Please switch to the new version of the task {\tt simdata}
(what was called {\tt simdata2} in CASA 3.0.2).

The inputs are:
\small
\begin{verbatim}
#  oldsimdata :: mosaic simulation task:
project             =      'sim'        #  root for output files
complist            =         ''        #  [optional] componentlist table to observe
modelimage          =         ''        #  model sky image name
inbright            = 'unchanged'       #  set peak surface brightness in Jy/pixel or "unchanged"
ignorecoord         =      False        #  change model coordinates
startfreq           =    '89GHz'        #  [only if ignorecoord=T] frequency of first channel
chanwidth           =    '10MHz'        #  [only if ignorecoord=T] channel width
refdate             = '2012/05/21/22:05:00' #  center time/date of observation *see help
totaltime           =    '7200s'        #  total time of observation
integration         =      '10s'        #  integration (sampling) time
scanlength          =          5        #  number of integrations per pointing in the mosaic
direction           = ['J2000 19h00m00 -40d00m00'] #  mosaic center, or list of pointings
pointingspacing     =  '1arcmin'        #  spacing in between beams in mosaic
mosaicsize          = ['1.0arcmin', '1.0arcmin'] #  angular size of desired area to map [*NEW*]
caldirection        =         ''        #  pt source calibrator [experimental]
calflux             =      '1Jy'        #
checkinputs         =       'no'        #  graphically verify parameters [yes|no|only]
antennalist         = 'alma.out10.cfg'  #  antenna position file
noise_thermal       =       True        #  add thermal noise
     noise_mode     = 'tsys-atm'        #  tsys-atm: set PWV and use ATM library; tsys-manual:
                                        #   set t_sky and tau
     user_pwv       =        1.0        #  Precipitable Water Vapor in mm [tsys-atm only]
     t_ground       =      269.0        #  ambient temperature
     t_sky          =      263.0        #  atmospheric temperature [tsys-manual only]
     tau0           =        0.1        #  zenith opacity [tsys-manual only]
cell                = '0.1arcsec'       #  output cell/pixel size
imsize              = [128, 128]        #  output image size in pixels (x,y)
threshold           =  '0.01mJy'        #  flux level (+units) to stop cleaning
niter               =        500        #  maximum number of iterations
psfmode             =    'clark'        #  minor cycle PSF calculation method
weighting           =  'natural'        #  weighting to apply to visibilities
uvtaper             =      False        #  apply additional uv tapering of  visibilities.
stokes              =        'I'        #  Stokes params to image
fidelity            =       True        #  Calculate fidelity images
display             =       True        #  Plot simulation result images,figures
verbose             =      False        
\end{verbatim}
\normalsize

Much more detailed information, and use-case examples, can be found at 

\url{http://casaguides.nrao.edu/index.php?title=Simulating_Observations_in_CASA}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
