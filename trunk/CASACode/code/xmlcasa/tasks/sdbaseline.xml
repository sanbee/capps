<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd file:///opt/casa/code/xmlcasa/xml/casa.xsd">


<!-- This is the param set for sdbaseline -->

<task type="function" name="sdbaseline" startup="false" category="single dish">

  <shortdescription>ASAP SD task: fit/remove a spectral baseline </shortdescription>

  <description>ASAP SD calibration task (based on the ALMATST5 recommendations):
        fit/remove a spectral baseline 

        Modified (rename parameter interactive to verify) 2008-11-20 KS
        Modified (+interactive mask) 2008-08-20 KS
        Task Version 2008-01-28 TT
        split and modified from Task Version 2007-03-04 STM
</description>

  <input>

    <param type="string" name="sdfile"  mustexist="true">
    <description>name of input SD dataset</description>
    <value></value>
    </param>

    <param type="any" name="antenna">
            <description>antenna name or id (only effective for MS input)</description>
            <any type="variant" limittype="string int"/>
            <value type="int">0</value>
    </param> 

    <param type="string" name="fluxunit">
	    <description>units for line flux (K,Jy) (''=current)</description>
	    <value></value>
    </param>

    <param type="any" name="telescopeparm" subparam='true'>
	    <description>param of telescope for flux conversion</description>
            <any type='variant' limittype='string doubleArray'/>
	    <value type='string'></value>
    </param>

    <param type="string" name="specunit">
	    <description>units for spectral axis (channel,km/s,GHz)</description>
	    <value></value>
	    <allowed kind="enum">
	    <value></value>
	    <value>channel</value>
	    <value>km/s</value>
	    <value>GHz</value>
	    <value>MHz</value>
	    <value>kHz</value>
	    <value>Hz</value>
    </allowed>
    </param>

    <param type="string" name="frame">
	    <description>frequency reference frame, e.g. LSRK (''=current)</description>
	    <value></value>
    </param>

    <param type="string" name="doppler">
	    <description>doppler convention, e.g. RADIO (''=current)</description>
	    <value></value>
    </param>

    <param type="intArray" name="scanlist">
	    <description>list of scans to use (e.g. [1,2,3,4])</description>
	    <value></value>
    </param>

    <param type="string" name="field">
	    <description>string for selection by source name</description>
	    <value></value>
    </param>

    <param type="intArray" name="iflist">
	    <description>list of IF ids to select (e.g. [0,1])</description>
	    <value></value>
    </param>

    <param type="intArray" name="pollist">
            <description>list of polarization ids to select (e.g. [0,1])</description>
            <value></value>
    </param>

    <param type="double" name="tau">
            <description>atmospheric optical depth for correction</description>
            <value>0.0</value>
    </param>

    <param type="string" name="blmode">
	    <description>mode for baseline fitting</description>
	    <allowed kind="enum">
	    <value>auto</value>
	    <value>list</value>
	    <value>interact</value>
	    </allowed>
    </param>

    <param type="int" name="blpoly">
            <description>order of baseline polynomial</description>
            <value>5</value>
    </param>

    <param type="bool" name="verify">
            <description>verify the results of baseline fitting</description>
            <value>False</value>
    </param>

    <param type="intArray" name="masklist">
            <description>list of mask regions to INCLUDE in BASELINE fit</description>
            <value></value>
    </param>

    <param type="double" name="thresh" subparam='true'>
	    <description>S/N threshold for linefinder</description>
	    <value>5.0</value>
    </param>

    <param type="int" name="avg_limit" subparam='true'>
	    <description>channel averaging for broad lines</description>
	    <value>4</value>
    </param>

    <param type="intArray" name="edge" subparam='true'>
	    <description>channels to drop at beginning and end of spectrum</description>
	    <value type='vector'><value>0</value></value>
    </param>

    <param type="bool" name="batch" subparam='true'>
            <description>run faster but no detailed output in logger</description>
            <value>False</value>
    </param>

    <param type="string" name="outfile">
	    <description>output file name</description>
	    <value></value>
    </param>

    <param type="string" name="outform">
	    <description>output file format (ASCII,MS,SDFITS,ASAP)</description>
	    <value>ASAP</value>
	    <allowed kind="enum">
	    <value>ASCII</value>
	    <value>ascii</value>
	    <value>MS</value>
	    <value>ms</value>
	    <value>MS2</value>
	    <value>ms2</value>
	    <value>SDFITS</value>
	    <value>sdfits</value>
	    <value>ASAP</value>
	    <value>asap</value>
	    </allowed>
    </param>

    <param type="bool" name="overwrite">
            <description>overwrite the output file if already exists</description>
            <value>False</value>
    </param>


    <param type="int" name="plotlevel">
	    <description>plot results (0=none,1+=some,&lt;0=hardcopy)</description>
	    <value>0</value>
    </param>

    <constraints>
	    <when param="fluxunit">
		<equals value=""/>
		<equals value="K">
			<default param="telescopeparm"><value type='string'></value></default>
		</equals>
	        <equals value="k">
			<default param="telescopeparm"><value type='string'></value></default>
	        </equals>
	        <equals value="Jy">
			<default param="telescopeparm"><value type='string'></value></default>
	        </equals>
	        <equals value="jy">
			<default param="telescopeparm"><value type='string'></value></default>
	        </equals>
	    </when>
	    <when param="blmode">
		<equals value="auto">
			<default param="thresh"><value>5.0</value></default>
			<default param="avg_limit"><value>4</value></default>
			<default param="edge"><value type='vector'><value>0</value></value></default>
                        <default param="batch"><value>False</value></default>
	        </equals>
		<equals value="list">
                        <default param="batch"><value>False</value></default>
                </equals>
                <equals value="interact"/>
	    </when>
    </constraints>

    </input>

  <returns type="void"/>

  <example>
        Keyword arguments:
        sdfile -- name of input SD dataset
        antenna -- antenna name or id (only effective for MS input). 
        fluxunit -- units for line flux
                options: 'K','Jy',''
                default: '' (keep current fluxunit)
                WARNING: For GBT data, see description below.
            &gt;&gt;&gt; fluxunit expandable parameter
                 telescopeparm -- the telescope characteristics
                        options: (str) name or (list) list of gain info
                        default: '' (none set)
                        example: if telescopeparm='', it tries to get the telescope
                                 name from the data.
                                 Full antenna parameters (diameter,ap.eff.) known
                                 to ASAP are
                                 'ATPKSMB', 'ATPKSHOH', 'ATMOPRA', 'DSS-43',
                                 'CEDUNA','HOBART'. For GBT, it fixes default fluxunit
                                 to 'K' first then convert to a new fluxunit.
                                 telescopeparm=[104.9,0.43] diameter(m), ap.eff.
                                 telescopeparm=[0.743] gain in Jy/K
                                 telescopeparm='FIX' to change default fluxunit
                                 see description below
        specunit -- units for spectral axis
                options: (str) 'channel','km/s','GHz','MHz','kHz','Hz'
                default: '' (=current)
                example: this will be the units for masklist
        frame -- frequency frame for spectral axis
                options: (str) 'LSRK','REST','TOPO','LSRD','BARY',
                         'GEO','GALACTO','LGROUP','CMB'
                default: currently set frame in scantable
                WARNING: frame='REST' not yet implemented
        doppler -- doppler mode
                options: (str) 'RADIO','OPTICAL','Z','BETA','GAMMA'
                default: currently set doppler in scantable
        scanlist -- list of scan numbers to process
                default: [] (use all scans)
                example: [21,22,23,24]
                         this selection is in addition to field,
                         iflist, and pollist
        field -- selection string for selecting scans by name
                default: '' (no name selection)
                example: 'FLS3a*'
                         this selection is in addition to scanlist,
                         iflist, and pollist
        iflist -- list of IF id numbers to select
                default: [] (use all IFs)
                example: [15]
                         this selection is in addition to scanlist,
                         field, and pollist
        pollist -- list of polarization id numbers to select
                default: [] (use all polarizations)
                example: [1]
                this selection is in addition to scanlist,
                field, and iflist
        tau -- atmospheric optical depth
                default: 0.0 (no correction)
        blmode -- mode for baseline fitting
                options: (str) 'auto','list','interact'
                default: 'auto'
                example: blmode='auto' uses expandable parameters 
                         in addition to blpoly to run linefinder
                         to determine line-free regions
                         USE WITH CARE! May need to tweak the parameters,
                         thresh, avg_limit, and edge.
                         blmode='interact' allows adding and deleting mask 
                         regions by drawing rectangles on the plot with mouse. 
                         Draw a rectangle with LEFT-mouse to ADD the region to 
                         the mask and with RIGHT-mouse to DELETE the region. 
               
            &gt;&gt;&gt; blmode expandable parameters
                 thresh -- S/N threshold for linefinder
                         default: 5
                         example: a single channel S/N ratio above which the channel is
                                  considered to be a detection
                 avg_limit -- channel averaging for broad lines
                         default: 4
                         example: a number of consecutive channels not greater than
                                  this parameter can be averaged to search for broad lines
                 edge -- channels to drop at beginning and end of spectrum
                         default: 0
                         example: [1000] drops 1000 channels at beginning AND end
                                  [1000,500] drops 1000 from beginning and 500 from end
                 batch -- run faster but no detailed output in logger
                         default: False
                         example: If True, this task runs faster, but the detailed 
                                  info such as the coefficients of the best-fit function 
                                  is not shown in the CASA logger
                 Note: For bad baselines threshold should be increased,
                 and avg_limit decreased (or even switched off completely by
                 setting this parameter to 1) to avoid detecting baseline
                 undulations instead of real lines.
        blpoly -- order of baseline polynomial
                options: (int) (&lt;0 turns off baseline fitting)
                default: 5
                example: typically in range 2-9 (higher values
                         seem to be needed for GBT)
        verify -- verify the results of baseline fitting
                options: (bool) True,False
                default: False
                WARNING: Currently this just asks whether you accept
                         the displayed fit and if not, continues
                         without doing any baseline fit.
        masklist -- list of mask regions to INCLUDE in BASELINE fit
                default: [] (entire spectrum)
                example: [[1000,3000],[5000,7000]]
                         if blmode='auto' then this mask will be applied
                         before fitting
        outfile -- Name of output file
                default: '' (&lt;sdfile&gt;_bs)
        outform -- format of output file
                options: 'ASCII','SDFITS','MS','ASAP'
                default: 'ASAP'
                example: the ASAP format is easiest for further sd
                         processing; use MS for CASA imaging.
                         If ASCII, then will append some stuff to
                         the outfile name
        overwrite -- overwrite the output file if already exists
                options: (bool) True,False
                default: False
                WARNING: if outform='ASCII', this parameter is ignored
        plotlevel -- control for plotting of results
                options: (int) 0=none, 1=some, 2=more, &lt;0=hardcopy
                default: 0 (no plotting)
                example: plotlevel&lt;0 as abs(plotlevel), e.g.
                         -1 => hardcopy of final plot (will be named
                        &lt;outfile&gt;_bspec.eps)
                WARNING: be careful plotting in fsotf mode!



        DESCRIPTION:

        Task sdbaseline performs baseline fitting/removal for single-dish spectra.
        The fit parameters, terms and rms of base-line are saved to an ascii 
        file, '&lt;outfile&gt;_blparam.txt'. 

        ASAP recognizes the data of the "AT" telescopes, but currently
        does not know about the GBT or any other telescope. This task
        does know about GBT. Telescope name is obtained from the data.
        If you wish to change the fluxunit (see below), and telescopeparm='',
        for the AT telescopes it will use internal telescope parameters for
        flux conversion. For GBT, it will use an approximate aperture
        efficiency conversion.  If you give telescopeparm a list , 
        then if the list has a single float it is assumed to
        be the gain in Jy/K, if two or more elements they are assumed
        to be telescope diameter (m) and aperture efficiency
        respectively.

        Note that sdbaseline assumes that the fluxunit is set correctly in
        the data already.  If not, then set telescopeparm='FIX' and it
        will set the default units to fluxunit without conversion.
        NOTE: If the data in sdfile is an ms from GBT and the default flux
        unit is missing and this task automatically fixes the default fluxunit
        to 'K' before the conversion.

        WARNING for the GBT raw SDFITS format data as input:
        Currently, all SDtasks cannot handle GBT raw SDFITS format data
        (in which the data are stored in multiple tables within SDFITS).
        It may be still possible to reduce GBT data after some
        preprocessing (outside CASA) of the raw SDFITS to a SDFITS with
        a single data table or to other data formats handled by SDtasks.

  </example>

</task>

</casaxml>
